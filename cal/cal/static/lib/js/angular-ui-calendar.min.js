angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(a,b){var c=a.eventSources,d=a.calendarWatchEvent?a.calendarWatchEvent:angular.noop,e=function(b){return function(){if(a.$root.$$phase)return b.apply(this,arguments);var c=arguments,d=this;return a.$root.$apply(function(){return b.apply(d,c)})}},f=1;this.eventFingerprint=function(a){a._id||(a._id=f++);var b=d({event:a})||"",c=moment.isMoment(a.start)?a.start.unix():a.start?moment(a.start).unix():"",e=moment.isMoment(a.end)?a.end.unix():a.end?moment(a.end).unix():"";return[a._id,a.id||"",a.title||"",a.url||"",c,e,a.allDay||"",a.className||"",b].join("")};var g=1,h=1;this.sourceFingerprint=function(a){var b=""+(a.__id||(a.__id=g++)),c=angular.isObject(a)&&a.events;return c&&(b=b+"-"+(c.__id||(c.__id=h++))),b},this.allEvents=function(){return Array.prototype.concat.apply([],(c||[]).reduce(function(a,b){if(angular.isArray(b))a.push(b);else if(angular.isObject(b)&&angular.isArray(b.events)){var c=Object.keys(b).filter(function(a){return"_id"!==a&&"events"!==a});b.events.forEach(function(a){angular.extend(a,c)}),a.push(b.events)}return a},[]))},this.changeWatcher=function(a,b){var c,d=function(){return((angular.isFunction(a)?a():a)||[]).reduce(function(a,c){var d=b(c);return f[d]=c,a.push(d),a},[])},e=function(a,b){var c=(b||[]).reduce(function(a,b){return a[b]=!0,a},Object.create(null));return(a||[]).filter(function(a){return!c[a]})},f={},g=function(a,d){var g,h,i={},j=e(d,a);for(g=0;g<j.length;g++){var k=j[g],l=f[k];delete f[k];var m=b(l);m===k?c.onRemoved(l):(i[m]=k,c.onChanged(l))}var n=e(a,d);for(g=0;g<n.length;g++)h=n[g],i[h]||c.onAdded(f[h])};return c={subscribe:function(a,b){a.$watch(d,function(a,c){var d=!(b&&b(a,c)===!1);d&&g(a,c)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(a,b){var c={};return angular.extend(c,b),angular.extend(c,a),angular.forEach(c,function(a,b){"function"==typeof a&&(c[b]=e(c[b]))}),c},this.getLocaleConfig=function(a){if(!a.lang&&!a.locale||a.useNgLocale){var c=function(a){return(Object.keys(a)||[]).reduce(function(b,c){return b.push(a[c]),b},[])},d=b.DATETIME_FORMATS;return{monthNames:c(d.MONTH),monthNamesShort:c(d.SHORTMONTH),dayNames:c(d.DAY),dayNamesShort:c(d.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(a){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(b,c,d,e){function l(){var c=d.uiCalendar?b.$parent.$eval(d.uiCalendar):{},g=e.getFullCalendarConfig(c,a),h=e.getLocaleConfig(g);angular.extend(h,g),k={eventSources:f},angular.extend(k,h),k.calendars=null;var i={};for(var j in k)"eventSources"!==j&&(i[j]=k[j]);return JSON.stringify(i)}var h,f=b.eventSources,g=!1,i=e.changeWatcher(f,e.sourceFingerprint),j=e.changeWatcher(e.allEvents,e.eventFingerprint),k=null;b.destroyCalendar=function(){h&&h.fullCalendar&&h.fullCalendar("destroy"),h=d.calendar?a.calendars[d.calendar]=angular.element(c).html(""):angular.element(c).html("")},b.initCalendar=function(){h||(h=$(c).html("")),h.fullCalendar(k),d.calendar&&(a.calendars[d.calendar]=h)},b.$on("$destroy",function(){b.destroyCalendar()}),i.onAdded=function(b){h&&h.fullCalendar&&(h.fullCalendar(k),d.calendar&&(a.calendars[d.calendar]=h),h.fullCalendar("addEventSource",b),g=!0)},i.onRemoved=function(a){h&&h.fullCalendar&&(h.fullCalendar("removeEventSource",a),g=!0)},i.onChanged=function(){h&&h.fullCalendar&&(h.fullCalendar("refetchEvents"),g=!0)},j.onAdded=function(a){h&&h.fullCalendar&&h.fullCalendar("renderEvent",a,!!a.stick)},j.onRemoved=function(a){h&&h.fullCalendar&&h.fullCalendar("removeEvents",a._id)},j.onChanged=function(a){if(h&&h.fullCalendar)for(var b=h.fullCalendar("clientEvents",a._id),c=0;c<b.length;c++){var d=b[c];d=angular.extend(d,a),h.fullCalendar("updateEvent",d)}},i.subscribe(b),j.subscribe(b,function(){if(g===!0)return g=!1,!1}),b.$watch(l,function(a,c){a!==c?(b.destroyCalendar(),b.initCalendar()):a&&angular.isUndefined(h)&&b.initCalendar()})}}}]);