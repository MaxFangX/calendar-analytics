{% extends "base.html" %}
{% load staticfiles %}

{% block head %}
  {{ block.super }}

  <script type="text/javascript">
    // PSA G+ Logout
    gapi.load('auth2', function () {
      var auth2;
      auth2 = gapi.auth2.init({
        client_id: "{{ social_auth_google_plus_key }}",
        scope: "{{ social_auth_google_oauth2_scope | safe }}"
      });
      auth2.then(function () {
        // console.log("User is signed-in in Google+ platform?", auth2.isSignedIn.get() ? "Yes" : "No");
        if (auth2.isSignedIn.get()) {
          $('#logout').on('click', function (event) {
            event.preventDefault();
            auth2.signOut().then(function () {
              console.log("Logged out from Google+ platform");
              document.location = "/logout";
            });
          });
        }
      });
    });
  </script>

{% endblock %}

<!-- Information when logged in -->
{% block content %}
<div ng-controller="LoggedInCtrl" class="cal-home-logged-in">
  <ul class="nav nav-tabs">
    <li>
      <a href="/">CalendarAnalytics</a>
    </li>
    <li class="pull-right">
      <a id="logout" href="/logout">Log out</a>
    </li>
  </ul>
  {% if request.user.profile.authed %}

  <div ng-controller="CalendarCtrl as $ctrl" class="cal-calendar col-md-8">
    <!-- Enable / disable calendars button -->
    <div id="select-calendar-button">
      <div class="btn-group" >
      <button type="button"
        class="btn btn-default dropdown-toggle"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false">
        Select Calendars
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li ng-repeat="cal in calendars">
          <a href="#">
            <input type="checkbox" ng-model="cal.enabled" ng-click="$ctrl.refresh('panalytics')">
            {% verbatim %} {{ cal.summary }} {% endverbatim %}
          </a>
        </li>
      </ul>
      </div>
    </div>
    <!-- Calendar -->
    <div ui-calendar="uiConfig.calendar" calendar="panalytics" class="calendar" ng-model="$ctrl.eventSources"></div>
  </div>

  <!-- Lists and other info on the side -->
  <div class="col-md-4">
    <div class="cal-category-list" ng-controller="CategoriesCtrl">
      <h4 class="well">Categories - Last Week</h4>
      <ul class="list-group">
<!--         <li class="list-group-item" ng-repeat="category in categories">
          {% verbatim %} {{ category.label }}: {{ category.hours }} hours {% endverbatim %}
        </li> -->
      </ul>
      <!-- <nvd3 options="options" data="categories"></nvd3> -->
    </div>
    <div ng-controller="TagsCtrl as $ctrl">
      <h4 class="well">Tags - Cumulative</h4>
      <ul class="list-group">
        <li class="list-group-item" ng-repeat="tag in tags">
          {% verbatim %} {{ tag.label }}: {{ tag.hours }} hours {% endverbatim %}
          <form novalidate class="simple-form">{% csrf_token %}
            Label: <input type="text" ng-model="tag.label" /><br />
            Keywords: <input type="text" ng-model="tag.keywords" /><br />
            <input type="submit" ng-click="$ctrl.editTag(tag.id)" value="Edit Tag" />
          </form>
          <button class="btn btn-primary" ng-click="$ctrl.deleteTag(tag.id)">Delete Tag</button>
        </li>
      </ul>
      <!-- Add a tag -->
      <h5>Add a Tag</h5>
      <form novalidate class="simple-form">{% csrf_token %}
        Label: <input type="text" ng-model="tag.label" /><br />
        Keywords: <input type="text" ng-model="tag.keywords" /><br />
        <input type="submit" ng-click="$ctrl.addTag(tag)" value="Add Tag" />
      </form>
    </div>

    <!-- For new users, needing to connect their calendars -->
    {% else %}
      <div class="jumbotron">
        <h3><a href="/auth/google">Connect Google Calendar</a></h3>
      </div>
    {% endif %}

    <!-- Super user buttons -->
    {% if request.user.is_staff %}
      <div>
        <h4 class="well">Options</h4>
        <a href="/v1/sync"><button class="btn btn-primary pull-left">Sync</button></a>
        <a href="/v1/sync?full_sync=true"><button class="btn btn-primary pull-left">Full Sync</button></a>
        <a href="/v1/sync?sync_all=true"><button class="btn btn-primary pull-left">Sync All Calendars</button></a>
        <a href="/v1/sync?full_sync=true&sync_all=true"><button class="btn btn-primary pull-left">Full Sync All Calendars</button></a>
        <a href="/auth/clear"><button class="btn btn-primary pull-left">Reset Credentials</button></a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
