{% extends "base.html" %}
{% load staticfiles %}

{% block head %}
  {{ block.super }}

  <!-- START PSA G+ Logout -->
  <script type="text/javascript">
    // PSA G+ Logout
    gapi.load('auth2', function () {
      var auth2;
      auth2 = gapi.auth2.init({
        client_id: "{{ social_auth_google_plus_key }}",
        scope: "{{ social_auth_google_oauth2_scope | safe }}"
      });
      auth2.then(function () {
        // console.log("User is signed-in in Google+ platform?", auth2.isSignedIn.get() ? "Yes" : "No");
        if (auth2.isSignedIn.get()) {
          $('#logout').on('click', function (event) {
            event.preventDefault();
            auth2.signOut().then(function () {
              console.log("Logged out from Google+ platform");
              document.location = "/logout";
            });
          });
        }
      });
    });
  </script>
  <!-- END PSA G+ Logout -->

{% endblock %}

<!-- Information when logged in -->
{% block content %}
<div ng-controller="LoggedInCtrl" class="cal-home-logged-in">
  <ul class="nav nav-tabs">
    <li>
      <a href="/">CalendarAnalytics</a>
    </li>
    <li class="pull-right">
      <a id="logout" href="/logout">Log out</a>
    </li>
  </ul>
  {% if request.user.profile.authed %}

  <div ng-controller="CalendarCtrl as $ctrl" class="cal-calendar col-md-8">
    <!-- Enable / disable calendars button -->
    <div id="select-calendar-button">
      <div class="btn-group" >
      <button type="button"
        class="btn btn-default dropdown-toggle"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false">
        Select Calendars
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li ng-repeat="cal in calendars">
          <a href="#">
            <input type="checkbox" ng-model="cal.enabled" ng-click="$ctrl.refresh('panalytics')">
            {% verbatim %} {{ cal.summary }} {% endverbatim %}
          </a>
        </li>
      </ul>
      </div>
    </div>
    <!-- Calendar -->
    <div ui-calendar="uiConfig.calendar" calendar="panalytics" class="calendar" ng-model="$ctrl.eventSources"></div>
  </div>

  <!-- Lists and other info on the side -->
  <div class="col-md-4">
    <div ng-controller="CategoriesCtrl as $ctrl">
      <h4 class="well">Categories - Last Week</h4>
        <table class="table table-hover">
          <thead>
            <th>Label</th>
            <th>Hours</th>
          </thead>
          <tbody>
            <tr ng-repeat="category in categories">
              {% verbatim %}
              <!-- TODO: Add a checkbox -->
              <td ng-hide="category.editing">{{ category.label }}</td>
              <td ng-hide="category.editing">{{ category.hours }}</td>
              {% endverbatim %}
              <td ng-show="category.editing">
                Label<br>
                <input type="text" ng-model="category.newLabel">
              </td>
              <td></td>
              <td class="text-right text-nowrap" ng-show="category.editing">
                <button class="btn btn-success">
                  <span class="glyphicon glyphicon-ok" ng-click="$ctrl.submit(category.id)"></span>
                </button>
                <button class="btn btn-warning">
                  <span class="glyphicon glyphicon-remove" ng-click="$ctrl.cancelEdit(category.id)"></span>
                </button>
              </td>
              <td class="text-right text-nowrap" ng-hide="category.editing">
                <button class="btn btn-info">
                  <span class="glyphicon glyphicon-edit" ng-click="$ctrl.startEdit(category.id)"></span>
                </button>
                <button class="btn btn-danger">
                  <span class="glyphicon glyphicon-trash" ng-click="$ctrl.remove(category.id)"></span>
                </button>
              </td>
            </tr>
            <tr>
              <td class="text-nowrap">
                <button class="btn btn-success">Generate Categories</button>
              </td>
            </tr>
          </tbody>
        </table>
      <nvd3 options="options" data="categories"></nvd3>
    </div>
    <div ng-controller="TagsCtrl as $ctrl">
      <h4 class="well">Tags - Cumulative</h4>
        <table class="table table-hover">
          <thead>
            <th>Label</th>
            <th>Hours</th>
          </thead>
          <tbody>
            <tr ng-repeat="tag in tags">
              {% verbatim %}
              <td ng-hide="tag.editing">{{ tag.label }}</td>
              <td ng-hide="tag.editing">{{ tag.hours }}</td>
              {% endverbatim %}
              <td ng-show="tag.editing">
                Label<br>
                <input type="text" ng-model="tag.newLabel">
              </td>
              <td ng-show="tag.editing">
                Keywords<br>
                <input type="text" ng-model="tag.newKeywords">
              </td>
              <td class="text-right text-nowrap" ng-show="tag.editing">
                <button class="btn btn-success">
                  <span class="glyphicon glyphicon-ok" ng-click="$ctrl.submit(tag.id)"></span>
                </button>
                <button class="btn btn-warning">
                  <span class="glyphicon glyphicon-remove" ng-click="$ctrl.cancelEdit(tag.id)"></span>
                </button>
              </td>
              <td class="text-right text-nowrap" ng-hide="tag.editing">
                <button class="btn btn-info">
                  <span class="glyphicon glyphicon-edit" ng-click="$ctrl.startEdit(tag.id)"></span>
                </button>
                <button class="btn btn-danger">
                  <span class="glyphicon glyphicon-trash" ng-click="$ctrl.delete(tag.id)"></span>
                </button>
              </td>
            </tr>
            <tr>
              <td>Label<br>
                <input type="text" ng-model="tag.label">
              </td>
              <td>Keywords<br>
               <input type="text" ng-model="tag.keywords">
              </td>
              <td class="text-right text-nowrap">
                <button class="btn btn-primary">
                  <span class="glyphicon glyphicon-plus" ng-click="$ctrl.create(tag)"></span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
    </div>

    <!-- For new users, needing to connect their calendars -->
    {% else %}
      <div class="jumbotron">
        <h3><a href="/auth/google">Connect Google Calendar</a></h3>
      </div>
    {% endif %}

    <!-- Super user buttons -->
    {% if request.user.is_staff %}
      <div>
        <h4 class="well">Options</h4>
        <a href="/v1/sync"><button class="btn btn-primary pull-left">Sync</button></a>
        <a href="/v1/sync?full_sync=true"><button class="btn btn-primary pull-left">Full Sync</button></a>
        <a href="/v1/sync?sync_all=true"><button class="btn btn-primary pull-left">Sync All Calendars</button></a>
        <a href="/v1/sync?full_sync=true&sync_all=true"><button class="btn btn-primary pull-left">Full Sync All Calendars</button></a>
        <a href="/auth/clear"><button class="btn btn-primary pull-left">Reset Credentials</button></a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
