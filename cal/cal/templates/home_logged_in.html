{% extends "base.html" %}
{% load staticfiles %}

{% block head %}
  {{ block.super }}
	<!-- BEGIN FullCalendar -->
  <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.6.1/fullcalendar.min.css' />
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.4/moment-timezone-with-data-2010-2020.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.6.1/fullcalendar.min.js"></script>
	<!-- END FullCalendar -->

  <!-- START PSA G+ Logout -->
  <script type="text/javascript">
    gapi.load('auth2', function () {
      var auth2;
      auth2 = gapi.auth2.init({
        client_id: "{{ social_auth_google_plus_key }}",
        scope: "{{ social_auth_google_oauth2_scope | safe }}"
      });
      auth2.then(function () {

				console.log("User is signed-in in Google+ platform?", auth2.isSignedIn.get() ? "Yes" : "No");

        if (auth2.isSignedIn.get()) {
          $('#logout').on('click', function (event) {
            event.preventDefault();
            auth2.signOut().then(function () {
              console.log("Logged out from Google+ platform");
              document.location = "/logout";
            });
          });
        }
      });
    });
  </script>
  <!-- END PSA G+ Logout -->

{% endblock %}

{% block content %}
<div class="cal-home-logged-in">
  <ul class="nav nav-tabs">
    <li>
      <a href="/">CalendarAnalytics</a>
    </li>
    <li class="pull-right">
      <a id="logout" href="/logout">Log out</a>
    </li>
  </ul>
  {% if request.user.profile.authed %}
    <div class="jumbotron">
				<div id='calendar' class="cal-calendar"></div>
    </div>
    <div class="col-md-6">
      {% include "_category_list.html"%}
    </div>
    <div class="col-md-6">
      {% include "_tag_list.html"%}
    </div>
  {% else %}
    <div class="jumbotron">
        <h3><a href="/auth/google">Connect Google Calendar</a></h3>
    </div>
  {% endif %}
  {% if request.user.is_staff %}
    <a href="/v1/sync?full_sync=True"><button class="btn btn-primary pull-right">Full sync</button></a>
    <a href="/v1/sync"><button class="btn btn-primary pull-right">Sync</button></a>
    <a href="/auth/clear"><button class="btn btn-primary pull-right">Reset credentials</button></a>
  {% endif %}
  <br>
</div>
{% endblock %}

{% block bottom_js %}
  {{ block.super }}
	<!-- BEGIN FullCalendar -->
	<script>
      $(document).ready(function() {
          $('#calendar').fullCalendar({
              defaultView: 'agendaWeek',
              events: function(start, end, timezone, callback) {
                  var query_timezone = '';
                  if (!timezone) {
                      query_timezone = 'UTC';
                  } else if (timezone === 'local') {
                      query_timezone = moment.tz.guess();
                  } else {
                      query_timezone = timezone;
                  }
                  $.ajax({
                      url: "/v1/gevents.json",
                      dataType: 'json',
                      data: {
                          start: start.toISOString(),
                          end: end.toISOString(),
                          timezone: query_timezone,
                      },
                      success: function(data) {
                          var events = [];
                          $.each(data.results, function(index, gevent) {
                              events.push({
                                  {% if request.user.is_staff %}
                                  title: gevent.id + " " + gevent.name,
                                  {% else %}
                                  title: gevent.name,
                                  {% endif %}
                                  start: gevent.start,
                                  end: gevent.end,
                                  backgroundColor: gevent.color.background,
                                  textColor: gevent.color.foreground,
                                  borderColor: gevent.color.foreground,
                              })
                          });
                          callback(events);

                      }
                  });
              },
              timezone: 'local',
          })
      });
	</script>
	<!-- END FullCalendar -->
{% endblock %}
