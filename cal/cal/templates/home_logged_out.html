{% extends "base.html" %}

{% block top_html %}
  <html itemscope itemtype="http://schema.org/Article">
  <!-- ^ Google Server-Side App Sign In-->
{% endblock %}

{% block head %}
  {{ block.super }}
  <!-- BEGIN Google Server-Side App Sign In Pre-requisites -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer></script>
  <!-- END Google Server-Side App Sign In Pre-requisites -->

  <script>
    function start() {
      gapi.load('auth2', function() {
        auth2 = gapi.auth2.init({
          client_id: "{{ google_client_id }}",
          // Scopes to request in addition to 'profile' and 'email'
          scope: 'https://www.googleapis.com/auth/calendar',
          redirect_uri: 'postmessage'
        });
      });
    }
  </script>
{% endblock %}

{% block content %}
  <h1>Public homepage</h1>
  <a href="/auth/google">Connect Google Calendar</a><br>
  <button id="signinButton">Sign in with Google</button>
  <script>
    $('#signinButton').click(function() {
      auth2.grantOfflineAccess({'redirect_uri': 'postmessage'}).then(signInCallback);
    });
  </script>
  <div id="result"></div>
  
  <h3>csrftoken: {{ csrf_token }}</h3>
{% endblock %}

{% block bottom_js %}
  {{ block.super }}
  <script>
    function signInCallback(authResult) {
      if (authResult['code']) {

        // Hide the sign-in button now that the user is authorized, for example:
        $('#signinButton').attr('style', 'display: none');

        // CSRF implementation for ajax requests
        function csrfSafeMethod(method) {
          // these HTTP methods do not require CSRF protection
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
          beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
          }
        });

        // Send the code to the server
        $.ajax({
          type: 'POST',
          url: '{{ base_url }}/auth/google',
          contentType: 'application/octet-stream; charset=utf-8',
          success: function(result) {
            // Handle or verify the server response.
          },
          error: function(result) {
            console.log("Request failed: " + result);
          },
          processData: false,
          data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            code: authResult['code'],
          }
        });
      } else {
        // There was an error.
        console.log('no authResult["Code"]')
      }
    }
  </script>
{% endblock %}
